#include <Servo.h>

const int dustSensorPin = A0;  // ë¯¸ì„¸ë¨¼ì§€ ì„¼ì„œ í•€
const int servoPin = 3;        // ì„œë³´ëª¨í„° í•€
Servo sun;

int currentAngle = 0;
bool isClosed = false;
unsigned long lastClearTime = 0;
const unsigned long openDelay = 3000; // 3ì´ˆ

void setup() {
  sun.attach(servoPin);
  sun.write(currentAngle); // ì´ˆê¸°ê°’ (ì™„ì „ ì—´ë¦¼)
  Serial.begin(9600);
}

void loop() {
  int dustRaw = analogRead(dustSensorPin);          // 0~1023
  float dustPct = map(dustRaw, 0, 1023, 0, 100);     // ë¹„ìœ¨ ë³€í™˜

  Serial.print("ğŸŒ« Dust Raw: ");
  Serial.print(dustRaw);
  Serial.print(" | Dust %: ");
  Serial.println(dustPct);

  unsigned long now = millis();

  // 1. ë¯¸ì„¸ë¨¼ì§€ ë†ë„ ë†’ìŒ â†’ ë‹«ê¸°
  if (dustPct >= 40) {
    if (currentAngle != 180) {
      smoothMoveServo(currentAngle, 180, 10);
      currentAngle = 180;
      Serial.println(">> ë¯¸ì„¸ë¨¼ì§€ ë‚˜ì¨: ì°½ë¬¸ ë‹«ìŒ");
    }
    isClosed = true;
    lastClearTime = 0;
  }

  // 2. ë¯¸ì„¸ë¨¼ì§€ ë§¤ìš° ì¢‹ìŒ & 3ì´ˆ ì´ìƒ ì§€ì† â†’ ì—´ê¸°
  else if (dustPct < 20) {
    if (isClosed) {
      if (lastClearTime == 0) {
        lastClearTime = now;
        Serial.println(">> ë¯¸ì„¸ë¨¼ì§€ ì¢‹ì•„ì§: 3ì´ˆ ëŒ€ê¸° ì‹œì‘");
      } else if (now - lastClearTime >= openDelay) {
        smoothMoveServo(currentAngle, 0, 10);
        currentAngle = 0;
        isClosed = false;
        lastClearTime = 0;
        Serial.println(">> âœ… ê³µê¸° ê¹¨ë—í•¨: ì°½ë¬¸ ì—´ë¦¼");
      }
    }
  }

  // 3. ì¤‘ê°„ ë†ë„ â†’ ë°˜ì¯¤ ì—´ê¸°
  else {
    int targetAngle = map((int)dustPct, 20, 40, 0, 90);  // 20%â†’0ë„, 40%â†’90ë„
    if (abs(currentAngle - targetAngle) > 3) {
      smoothMoveServo(currentAngle, targetAngle, 10);
      currentAngle = targetAngle;
      Serial.print(">> ê³µê¸° ë³´í†µ: ì°½ë¬¸ ê°ë„ ");
      Serial.print(currentAngle);
      Serial.println("ë„");
    }
    lastClearTime = 0;
  }

  delay(300);  // ë…¸ì´ì¦ˆ ë°©ì§€
}

// ë¶€ë“œëŸ¬ìš´ ì„œë³´ íšŒì „ í•¨ìˆ˜
void smoothMoveServo(int fromAngle, int toAngle, int delayPerStep) {
  if (fromAngle < toAngle) {
    for (int a = fromAngle; a <= toAngle; a++) {
      sun.write(a);
      delay(delayPerStep);
    }
  } else {
    for (int a = fromAngle; a >= toAngle; a--) {
      sun.write(a);
      delay(delayPerStep);
    }
  }
}
