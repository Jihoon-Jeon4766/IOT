#include <Servo.h>

const int rainSensorPin = A0;  // ë¹„ ê°ì§€ ì„¼ì„œ í•€
const int servoPin = 3;        // ì„œë³´ëª¨í„° í•€
Servo sun;

int currentAngle = 0;                 // í˜„ì¬ ì„œë³´ ê°ë„
bool isClosed = false;               // ì°½ë¬¸ì´ ë‹«íŒ ìƒíƒœ ì—¬ë¶€
unsigned long lastBelow10Time = 0;   // 10% ë¯¸ë§Œ ìœ ì§€ ì‹œì‘ ì‹œê°„
const unsigned long openDelay = 3000; // 3ì´ˆ ì¡°ê±´

void setup() {
  sun.attach(servoPin);
  sun.write(currentAngle); // ì´ˆê¸°ê°’ (ì™„ì „ ì—´ë¦¼)
  Serial.begin(9600);
}

void loop() {
  int rawValue = analogRead(rainSensorPin);   // 0~1023
  float percentage = map(rawValue, 0, 1023, 0, 100); // %ë¡œ í™˜ì‚°

  Serial.print("Raw: ");
  Serial.print(rawValue);
  Serial.print(" | Percentage: ");
  Serial.print(percentage);
  Serial.print("% | Status: ");

  // ìƒíƒœ í…ìŠ¤íŠ¸ ì¶œë ¥
  if (percentage < 10) Serial.println("â˜€ï¸ ë§¤ìš° ë§‘ìŒ (ì—´ê¸° ê°€ëŠ¥)");
  else if (percentage < 30) Serial.println("ğŸŒ¤ ì•½ê°„ ìŠµí•¨ (ë°˜ì¯¤ ì—´ê¸°)");
  else Serial.println("ğŸŒ§ ë¹„ ë§ì´ ì˜´ (ë‹«ê¸°)");

  unsigned long now = millis();

  // âœ… ì¡°ê±´1: ë¹„ ë§ì´ ì˜¬ ë•Œ â†’ ë‹«ê¸°
  if (percentage >= 30) {
    if (currentAngle != 180) {
      smoothMoveServo(currentAngle, 180, 10);  // ë¶€ë“œëŸ½ê²Œ ë‹«ê¸°
      currentAngle = 180;
      Serial.println(">> ì°½ë¬¸ ë‹«ìŒ");
    }
    isClosed = true;
    lastBelow10Time = 0;
  }

  // âœ… ì¡°ê±´2: ë¹„ ë©ˆì¶”ê³  3ì´ˆ ë™ì•ˆ 10% ë¯¸ë§Œ â†’ ì—´ê¸°
  else if (percentage < 10) {
    if (isClosed) {
      if (lastBelow10Time == 0) {
        lastBelow10Time = now;
        Serial.println(">> ë¹„ ë©ˆì¶¤ ê°ì§€: 3ì´ˆ ëŒ€ê¸° ì‹œì‘");
      } else if (now - lastBelow10Time >= openDelay) {
        smoothMoveServo(currentAngle, 0, 10);  // ë¶€ë“œëŸ½ê²Œ ì—´ê¸°
        currentAngle = 0;
        isClosed = false;
        lastBelow10Time = 0;
        Serial.println(">> ì°½ë¬¸ ì—´ë¦¼");
      }
    }
  }

  // âœ… ì¡°ê±´3: ì¤‘ê°„ ìƒíƒœ â†’ ë°˜ì¯¤ ì—´ê¸° (ë¶€ë“œëŸ½ê²Œ ì¡°ì ˆ)
  else {
    int targetAngle = map((int)percentage, 10, 30, 0, 90);
    if (abs(currentAngle - targetAngle) > 3) {  // ë„ˆë¬´ ìì£¼ ì›€ì§ì´ì§€ ì•Šë„ë¡ ì¡°ê±´
      smoothMoveServo(currentAngle, targetAngle, 10);
      currentAngle = targetAngle;
      Serial.print(">> ì°½ë¬¸ ì¡°ì ˆ: ");
      Serial.print(currentAngle);
      Serial.println("ë„");
    }
    lastBelow10Time = 0;
  }

  delay(200);  // ì„¼ì„œ ë…¸ì´ì¦ˆ ë°©ì§€
}

// âœ… ì„œë³´ë¥¼ ë¶€ë“œëŸ½ê²Œ ì›€ì§ì´ëŠ” í•¨ìˆ˜
void smoothMoveServo(int fromAngle, int toAngle, int delayPerStep) {
  if (fromAngle < toAngle) {
    for (int a = fromAngle; a <= toAngle; a++) {
      sun.write(a);
      delay(delayPerStep);
    }
  } else {
    for (int a = fromAngle; a >= toAngle; a--) {
      sun.write(a);
      delay(delayPerStep);
    }
  }
}

